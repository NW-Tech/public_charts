{{- if (and .Values.monitoring.enabled .Values.monitoring.prometheus.enabled) }}
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ include "app.fullname" . }}-prometheus-federation
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "app.labels" . | nindent 4 }}
    app.kubernetes.io/component: prometheus-federation

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: {{ include "app.fullname" . }}-prometheus-federation
  labels:
    {{- include "app.labels" . | nindent 4 }}
    app.kubernetes.io/component: prometheus-federation
rules:
  - apiGroups: [""]
    resources:
      - nodes
      - nodes/metrics
      - services
      - endpoints
      - pods
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources:
      - configmaps
    verbs: ["get"]
  - apiGroups:
      - networking.k8s.io
    resources:
      - ingresses
    verbs: ["get", "list", "watch"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: {{ include "app.fullname" . }}-prometheus-federation
  labels:
    {{- include "app.labels" . | nindent 4 }}
    app.kubernetes.io/component: prometheus-federation
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: {{ include "app.fullname" . }}-prometheus-federation
subjects:
  - kind: ServiceAccount
    name: {{ include "app.fullname" . }}-prometheus-federation
    namespace: {{ .Release.Namespace }}

---
apiVersion: monitoring.coreos.com/v1
kind: Prometheus
metadata:
  name: {{ include "app.fullname" . }}-prometheus-federation
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: prometheus-federation
    app.kubernetes.io/component: prometheus-federation
spec:
  replicas: {{ .Values.monitoring.prometheus.replicas }}

  serviceAccountName: {{ include "app.fullname" . }}-prometheus-federation

  podMonitorSelector:
    matchLabels:
      {{- include "app.selectorLabels" . | nindent 6 }}

  serviceMonitorSelector:
    {{- toYaml .Values.monitoring.prometheus.serviceMonitorSelector | nindent 4 }}

  resources:
    {{- toYaml .Values.monitoring.prometheus.resources | nindent 4 }}

  {{- if .Values.monitoring.prometheus.storage.enabled }}
  storage:
    volumeClaimTemplate:
      spec:
        accessModes:
          {{- toYaml .Values.monitoring.prometheus.storage.accessModes | nindent 10 }}
        resources:
          requests:
            storage: {{ .Values.monitoring.prometheus.storage.size }}
  {{- end }}

  retention: {{ .Values.monitoring.prometheus.retention }}

  securityContext:
    {{- toYaml .Values.monitoring.prometheus.securityContext | nindent 4 }}

  portName: http-web

  enableAdminAPI: {{ .Values.monitoring.prometheus.enableAdminAPI }}

  {{- with .Values.monitoring.prometheus.additionalScrapeConfigs }}
  additionalScrapeConfigs:
    name: {{ include "app.fullname" $ }}-prometheus-federation-additional
    key: prometheus-additional.yaml
  {{- end }}

---
# Service to expose Prometheus for federation
apiVersion: v1
kind: Service
metadata:
  name: {{ include "app.fullname" . }}-prometheus-federation
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "app.labels" . | nindent 4 }}
    app.kubernetes.io/component: prometheus-federation
  {{- with .Values.monitoring.prometheus.service.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  type: {{ .Values.monitoring.prometheus.service.type }}
  {{- if .Values.monitoring.prometheus.service.loadBalancerIP }}
  loadBalancerIP: {{ .Values.monitoring.prometheus.service.loadBalancerIP }}
  {{- end }}
  ports:
    - name: http-web
      port: {{ .Values.monitoring.prometheus.service.port }}
      targetPort: 9090
      protocol: TCP
  selector:
    app.kubernetes.io/name: prometheus-federation
    prometheus: {{ include "app.fullname" . }}-prometheus-federation

{{- if .Values.monitoring.prometheus.additionalScrapeConfigs }}
---
# ConfigMap for additional scrape configs
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "app.fullname" . }}-prometheus-federation-additional
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "app.labels" . | nindent 4 }}
    app.kubernetes.io/component: prometheus-federation
data:
  prometheus-additional.yaml: |
    {{- toYaml .Values.monitoring.prometheus.additionalScrapeConfigs | nindent 4 }}
{{- end }}
{{- end }}
